name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  ci:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - uses: actions/checkout@v4

      - name: Build
        id: build
        run: docker compose run --rm build

      - name: Test
        id: test
        if: steps.build.outcome == 'success'
        run: docker compose run --rm test

      - name: Check formatting
        id: format
        if: always()
        continue-on-error: true
        run: docker compose run --rm format-check

      - name: Lint
        id: lint
        if: always()
        continue-on-error: true
        run: docker compose run --rm lint

      - name: Comment PR
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            const build = '${{ steps.build.outcome }}';
            const test = '${{ steps.test.outcome }}';
            const format = '${{ steps.format.outcome }}';
            const lint = '${{ steps.lint.outcome }}';

            let body = '## Resultado do CI\n\n';
            body += '| Etapa | Status |\n';
            body += '|-------|--------|\n';

            if (build === 'success') {
              body += '| Build | Passou |\n';
            } else {
              body += `| Build | [Falhou](${runUrl}) |\n`;
            }

            if (build !== 'success') {
              body += '| Testes | — |\n';
            } else if (test === 'success') {
              body += '| Testes | Passou |\n';
            } else {
              body += `| Testes | [Falhou](${runUrl}) |\n`;
            }

            body += '\n';

            if (build !== 'success') {
              body += 'O código não compilou. Clique em "Falhou" para ver os erros.\n';
            } else if (test !== 'success') {
              body += 'Alguns testes falharam. Clique em "Falhou" para ver os detalhes.\n';
            } else {
              body += 'Tudo certo! Bom trabalho.\n';
            }

            if (build === 'success' && (format === 'failure' || lint === 'failure')) {
              body += '\n### Dicas\n\n';

              if (format === 'failure') {
                body += `**Formatação**: Alguns arquivos não seguem o padrão de formatação. Rode \`cmake --build build --target format\` para corrigir. [Ver detalhes](${runUrl})\n\n`;
              }

              if (lint === 'failure') {
                body += `**Linter**: O linter encontrou sugestões de melhoria. [Ver detalhes](${runUrl})\n`;
              }
            }

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const marker = '## Resultado do CI';
            const existing = comments.find(c => c.user.type === 'Bot' && c.body.startsWith(marker));

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }
